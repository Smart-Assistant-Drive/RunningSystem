services:
  dmvservice:
    image: ghcr.io/smart-assistant-drive/dmvservice:latest
    ports:
      - "8083:8083"
    environment:
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_HOST: mongodb
      SERVER_PORT: 8083
    depends_on:
      mongodb1:
        condition: service_healthy
    networks:
      mongo-net-1:
      default:

  dtenvironment:
    image: ghcr.io/smart-assistant-drive/dtsemaphores:latest
    ports:
      - "1884:1883"
      - "8070:8070"
      - "8090:8090"
      - "8080:8080"
      - "8095-8110:8095-8110" # Expose a range of ports for the semaphore service
    environment:
      BASE_HOST: 0.0.0.0
      BASE_PORT_SEMAPHORE: 8095
      MQTT_BROKER_HOST: mosquittoMqtt
      MQTT_BROKER_PORT: 1883
    depends_on:
      mosquittoMqtt:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8070/state/properties"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      mqtt-broker:

  junctionMAS:
    image: ghcr.io/smart-assistant-drive/semaphoremas:latest
    ports:
      - "8195-8210:8095-8110" # Expose a range of ports for the semaphore service
    environment:
      MQTT_HOST: mosquittoMqtt
      MQTT_PORT: 1883
      DT_HOST: dtenvironment
      DT_BASE_PORT: 8095
    depends_on:
      mosquittoMqtt:
        condition: service_healthy
      dtenvironment:
        condition: service_healthy
    networks:
      mqtt-broker:

  mongodb1:
    image: mongo:latest
    container_name: mongodb1
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: secret
      ME_CONFIG_MONGODB_SERVER: mongodb
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      start_period: 15s
      interval: 5s
      timeout: 10s
      retries: 10
    networks:
      mongo-net-1:
        aliases:
          - mongodb

  mongo-express1:
    image: mongo-express:latest
    container_name: mongo-express1
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://root:secret@mongodb:27017/
    depends_on:
      mongodb1:
        condition: service_healthy
    networks:
      mongo-net-1:

  mosquittoMqtt:
    image: eclipse-mosquitto:latest # Use the latest stable version of Mosquitto
    restart: unless-stopped # Always restart unless the container is explicitly stopped
    ports:
      - "1883:1883" # Standard MQTT port (unencrypted)
      - "9001:9001" # WebSocket port (for MQTT over WebSockets)
      # - "8883:8883" # Uncomment for MQTT over TLS/SSL (requires certificate configuration)
    volumes:
      # Mount a custom configuration file
      # You need to create a 'mosquitto.conf' file in a 'config' directory next to this docker-compose.yml
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

      # Persist data (messages, subscriptions, etc.)
      # This ensures data survives container restarts
      - mosquitto_data:/mosquitto/data

      # Persist logs
      - mosquitto_log:/mosquitto/log
    command: mosquitto -c /mosquitto/config/mosquitto.conf # Tell Mosquitto to use our custom config
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-p", "1883", "-t", "$$SYS/broker/uptime", "-C", "1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      mqtt-broker:

  # mongodb2:
  #   image: mongo:latest
  #   container_name: mongodb2
  #   ports:
  #     - "27018:27017"
  #   environment:
  #     MONGO_INITDB_ROOT_USERNAME: root
  #     MONGO_INITDB_ROOT_PASSWORD: example
  #     ME_CONFIG_MONGODB_SERVER: mongodb
  #   healthcheck:
  #     test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
  #     start_period: 15s
  #     interval: 5s
  #     timeout: 10s
  #     retries: 10
  #   networks:
  #     mongo-net-2:
  #       aliases:
  #         - mongodb

  # mongo-express2:
  #   image: mongo-express:latest
  #   container_name: mongo-express2
  #   ports:
  #     - "8082:8082"
  #   environment:
  #     ME_CONFIG_MONGODB_URL: mongodb://root:example@mongodb:27017/
  #     PORT: 8082
  #   depends_on:
  #     mongodb2:
  #       condition: service_healthy
  #   networks:
  #     mongo-net-2:

networks:
  mongo-net-1:
  mongo-net-2:
  mqtt-broker:

volumes:
  mosquitto_data: # Docker managed volume for Mosquitto data
  mosquitto_log:  # Docker managed volume for Mosquitto logs
