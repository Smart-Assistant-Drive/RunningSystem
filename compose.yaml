services:

  administrationgateway:
    image: ghcr.io/smart-assistant-drive/administrationgateway:latest
    ports:
      - "8087:8087"
    environment:
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_HOST: mongodb
      SERVER_PORT: 8087
      SIGN_SERVICE_HOST: http://trafficsignservice:8085
      ROAD_SERVICE_HOST: http://roadservice:8084
      ROAD_SERVICE_TRAFFICDT_HOST: http://trafficdt:8152
      ROAD_SERVICE_SEMAPHOREDT_HOST: http://dtsemaphore:8094
      ROAD_SERVICE_SEMAPHOREDT_ADMINHOST: http://dtsemaphore:8093
    depends_on:
      mongodb1:
        condition: service_healthy
    networks:
      mongo-net-1:
      default:

  publicgateway:
    image: ghcr.io/smart-assistant-drive/publicgateway:latest
    ports:
      - "8086:8086"
    environment:
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_HOST: mongodb
      SERVER_PORT: 8086
      SIGN_SERVICE_HOST: http://trafficsignservice:8085
      ROAD_SERVICE_HOST: http://roadservice:8084
      ACCESS_SERVICE_TRAFFICDT_HOST: http://trafficdt:8152
      ACCESS_SERVICE_SEMAPHOREDT_HOST: http://dtsemaphore:8093
    depends_on:
      mongodb1:
        condition: service_healthy
    networks:
      mongo-net-1:
      default:

  dmvservice:
    image: ghcr.io/smart-assistant-drive/dmvservice:latest
    ports:
      - "8083:8083"
    environment:
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_HOST: mongodb
      SERVER_PORT: 8083
      SPRING_DATA_MONGODB_DATABASE: dmvdb
    depends_on:
      mongodb1:
        condition: service_healthy
    networks:
      mongo-net-1:
      default:

  roadservice:
    image: ghcr.io/smart-assistant-drive/roadservice:latest
    ports:
      - "8084:8084"
    environment:
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_HOST: mongodb
      SPRING_DATA_MONGODB_USERNAME: root
      SERVER_PORT: 8084
      SPRING_DATA_MONGODB_DATABASE: roaddb
    depends_on:
      mongodb1:
        condition: service_healthy
    networks:
      mongo-net-1:
      default:

  trafficsignservice:
    image: ghcr.io/smart-assistant-drive/traffic-sign-service:latest
    ports:
      - "8085:8085"
    environment:
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_HOST: mongodb
      SERVER_PORT: 8085
      SPRING_DATA_MONGODB_DATABASE: trafficsigndb
    depends_on:
      mongodb1:
        condition: service_healthy
    networks:
      mongo-net-1:
      default:

  dtsemaphore:
    image: ghcr.io/smart-assistant-drive/dtsemaphores:latest
    ports:
      - "1884:1883"
      - "8070:8070"
      - "8090:8090"
      - "8080:8080"
      - "8093:8093"
      - "8095-8110:8095-8110" # Expose a range of ports for the semaphore service
    environment:
      BASE_HOST: 0.0.0.0
      BASE_PORT_SEMAPHORE: 8095
      MQTT_BROKER_HOST: mosquittoMqtt
      BASE_PORT_AGGREGATE: 8093
      AGGREGATE_DIGITAL_ADAPTER: 8094
      MQTT_BROKER_PORT: 1883
    depends_on:
      mosquittoMqtt:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8095/state/properties"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      mqtt-broker:
      default:

  trafficdt:
    image: ghcr.io/smart-assistant-drive/trafficdt:latest
    ports:
      - "1885:1883" # mqtt port for traffic digital twins
      - "8151:8151"
      - "8152:8152"
      - "8111-8150:8111-8150" # Expose a range of ports for all the traffic digital twins (http adapters)
    environment:
      BASE_HOST: 0.0.0.0
      BASE_PORT_SEMAPHORE: 8111 # DA CAMBIARE
      MQTT_BROKER_HOST: mosquittoMqtt
      MQTT_BROKER_PORT: 1883
      BASE_PORT_AGGREGATE: 8151
      AGGREGATE_DIGITAL_ADAPTER: 8152
    depends_on:
      mosquittoMqtt:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8152/state/properties"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      mqtt-broker:

  mongodb1:
    image: mongo:latest
    container_name: mongodb1
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: secret
      ME_CONFIG_MONGODB_SERVER: mongodb
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      start_period: 15s
      interval: 5s
      timeout: 10s
      retries: 10
    networks:
      mongo-net-1:
        aliases:
          - mongodb

  mongo-express1:
    image: mongo-express:latest
    container_name: mongo-express1
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://root:secret@mongodb:27017/
    depends_on:
      mongodb1:
        condition: service_healthy
    networks:
      mongo-net-1:

  mosquittoMqtt:
    image: eclipse-mosquitto:latest # Use the latest stable version of Mosquitto
    restart: unless-stopped # Always restart unless the container is explicitly stopped
    ports:
      - "1883:1883" # Standard MQTT port (unencrypted)
      - "9001:9001" # WebSocket port (for MQTT over WebSockets)
      # - "8883:8883" # Uncomment for MQTT over TLS/SSL (requires certificate configuration)
    volumes:
      # Mount a custom configuration file
      # You need to create a 'mosquitto.conf' file in a 'config' directory next to this docker-compose.yml
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

      # Persist data (messages, subscriptions, etc.)
      # This ensures data survives container restarts
      - mosquitto_data:/mosquitto/data

      # Persist logs
      - mosquitto_log:/mosquitto/log
    command: mosquitto -c /mosquitto/config/mosquitto.conf # Tell Mosquitto to use our custom config
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-p", "1883", "-t", "$$SYS/broker/uptime", "-C", "1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      mqtt-broker:

  # mongodb2:
  #   image: mongo:latest
  #   container_name: mongodb2
  #   ports:
  #     - "27018:27017"
  #   environment:
  #     MONGO_INITDB_ROOT_USERNAME: root
  #     MONGO_INITDB_ROOT_PASSWORD: example
  #     ME_CONFIG_MONGODB_SERVER: mongodb
  #   healthcheck:
  #     test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
  #     start_period: 15s
  #     interval: 5s
  #     timeout: 10s
  #     retries: 10
  #   networks:
  #     mongo-net-2:
  #       aliases:
  #         - mongodb

  # mongo-express2:
  #   image: mongo-express:latest
  #   container_name: mongo-express2
  #   ports:
  #     - "8082:8082"
  #   environment:
  #     ME_CONFIG_MONGODB_URL: mongodb://root:example@mongodb:27017/
  #     PORT: 8082
  #   depends_on:
  #     mongodb2:
  #       condition: service_healthy
  #   networks:
  #     mongo-net-2:

networks:
  mongo-net-1:
  mongo-net-2:
  mqtt-broker:

volumes:
  mosquitto_data: # Docker managed volume for Mosquitto data
  mosquitto_log:  # Docker managed volume for Mosquitto logs
